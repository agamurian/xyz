var D=Object.defineProperty,I=Object.defineProperties;var H=Object.getOwnPropertyDescriptors;var T=Object.getOwnPropertySymbols;var z=Object.prototype.hasOwnProperty,K=Object.prototype.propertyIsEnumerable;var F=(i,e,t)=>e in i?D(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,l=(i,e)=>{for(var t in e||(e={}))z.call(e,t)&&F(i,t,e[t]);if(T)for(var t of T(e))K.call(e,t)&&F(i,t,e[t]);return i},d=(i,e)=>I(i,H(e));var L=(i,e)=>{var t={};for(var s in i)z.call(i,s)&&e.indexOf(s)<0&&(t[s]=i[s]);if(i!=null&&T)for(var s of T(i))e.indexOf(s)<0&&K.call(i,s)&&(t[s]=i[s]);return t};import{derived as b,get as o,writable as m}from"svelte/store";var C=({parser:i,key:e,params:t,translations:s,locale:r,fallbackLocale:a})=>{if(!(e&&r))return console.warn("[i18n]: No translation key or locale provided. Skipping translation..."),"";let n=(s[r]||{})[e];return a&&n===void 0&&(n=(s[a]||{})[e]),i.parse(n,t,r,e)},h=(...i)=>i.length?i.filter(e=>!!e).map(e=>{let t=`${e}`.toLowerCase();try{[t]=Intl.Collator.supportedLocalesOf(e)}catch{console.warn(`[i18n]: Non-standard locale provided: '${i}'. Check your 'translations' and 'loaders' in i18n config...`)}return t}):[],P=(i,e)=>Object.keys(i||{}).reduce((t,s)=>{let r=i[s],a=e?`${e}.${s}`:`${s}`;return r&&typeof r=="object"?l(l({},t),P(r,a)):d(l({},t),{[a]:r})},{}),j=async i=>{try{return(await Promise.all(i.map(r=>{var a=r,{loader:t}=a,s=L(a,["loader"]);return new Promise(async n=>{let c;try{c=await t()}catch(v){console.error(`[i18n]: Failed to load translation. Verify your '${s.locale}' > '${s.key}' Loader.`),console.error(v)}n(d(l({loader:t},s),{data:c}))})}))).reduce((t,{key:s,data:r,locale:a})=>{if(!r)return t;let[n]=h(a);return d(l({},t),{[n]:P(d(l({},t[n]||{}),{[s]:r}))})},{})}catch(e){console.error(e)}return{}},k=i=>e=>{try{if(typeof e=="string")return e===i;if(typeof e=="object")return e.test(i)}catch{throw new Error("[i18n]: Invalid route config!")}return!1},N=(i,e)=>{let t=!0;try{t=Object.keys(i).filter(s=>i[s]!==void 0).every(s=>i[s]===e[s])}catch{}return t};var A=1e3*60*60*24,O=class{constructor(e){this.cachedAt=0;this.loadedKeys={};this.currentRoute=m();this.config=m();this.isLoading=m(!1);this.promises=new Set;this.loading={subscribe:this.isLoading.subscribe,toPromise:(e,t)=>{let s=Array.from(this.promises).filter(r=>N({locale:h(e)[0],route:t},r)).map(({promise:r})=>r);return Promise.all(s)},get:()=>o(this.isLoading)};this.privateTranslations=m({});this.translations={subscribe:this.privateTranslations.subscribe,get:()=>o(this.translations)};this.locales=d(l({},b([this.config,this.privateTranslations],([e,t])=>{if(!e)return[];let{loaders:s=[]}=e,r=s.map(({locale:n})=>h(n)[0]),a=Object.keys(t).map(n=>h(n)[0]);return Array.from(new Set([...r,...a]))},[])),{get:()=>o(this.locales)});this.internalLocale=m();this.loaderTrigger=b([this.internalLocale,this.currentRoute],([e,t],s)=>{var r,a,n;e!==void 0&&t!==void 0&&(e!==((r=o(this.loaderTrigger))==null?void 0:r[0])||t!==((a=o(this.loaderTrigger))==null?void 0:a[1]))&&((n=o(this.config))!=null&&n.debug&&console.debug("[i18n]: Triggering translation load..."),s([e,t]))},[]);this.localeHelper=m();this.locale={subscribe:this.localeHelper.subscribe,forceSet:this.localeHelper.set,set:this.internalLocale.set,update:this.internalLocale.update,get:()=>o(this.locale)};this.initialized=b([this.locale,this.currentRoute,this.privateTranslations],([e,t,s],r)=>{o(this.initialized)||r(e!==void 0&&t!==void 0&&!!Object.keys(s).length)});this.translation=b([this.privateTranslations,this.locale,this.isLoading],([e,t,s],r)=>{let a=e[t];a&&Object.keys(a).length&&!s&&r(a)},{});this.t=d(l({},b([this.config,this.translation],([{parser:e,fallbackLocale:t}])=>(s,...r)=>C({parser:e,key:s,params:r,translations:this.translations.get(),locale:this.locale.get(),fallbackLocale:t}))),{get:(e,...t)=>o(this.t)(e,...t)});this.l=d(l({},b([this.config,this.translations],([{parser:e,fallbackLocale:t},s])=>(r,a,...n)=>C({parser:e,key:a,params:n,translations:s,locale:r,fallbackLocale:t}))),{get:(e,t,...s)=>o(this.l)(e,t,...s)});this.getLocale=e=>{if(!e)return"";let s=this.locales.get().find(r=>r===h(e)[0])||"";return h(s)[0]||""};this.setLocale=e=>{var s;if(!e)return;let[t]=h(e);if(t!==o(this.internalLocale))return(s=o(this.config))!=null&&s.debug&&console.debug(`[i18n]: Setting '${t}' locale.`),this.internalLocale.set(t),this.loading.toPromise(e,o(this.currentRoute))};this.setRoute=e=>{var t;if(e!==o(this.currentRoute)){(t=o(this.config))!=null&&t.debug&&console.debug(`[i18n]: Setting '${e}' route.`),this.currentRoute.set(e);let s=o(this.internalLocale);return this.loading.toPromise(s,e)}};this.loadConfig=async e=>{await this.configLoader(e)};this.getTranslationProps=async(e=this.locale.get(),t=o(this.currentRoute))=>{let s=o(this.config);if(!s||!e)return[];let r=this.translations.get(),{loaders:a,fallbackLocale:n="",cache:c=A}=s||{},v=Number.isNaN(+c)?A:+c;this.cachedAt?Date.now()>v+this.cachedAt&&(s!=null&&s.debug&&console.debug("[i18n]: Refreshing cache."),this.loadedKeys={},this.cachedAt=0):(s!=null&&s.debug&&console.debug("[i18n]: Setting cache timestamp."),this.cachedAt=Date.now());let[S,w]=h(e,n),E=r[S],W=r[w],x=(a||[]).map(R=>{var u=R,{locale:g}=u,f=L(u,["locale"]);return d(l({},f),{locale:h(g)[0]})}).filter(({routes:g})=>!g||(g||[]).some(k(t))).filter(({key:g,locale:f})=>f===S&&(!E||!(this.loadedKeys[S]||[]).includes(g))||n&&f===w&&(!W||!(this.loadedKeys[w]||[]).includes(g)));if(x.length){this.isLoading.set(!0),s!=null&&s.debug&&console.debug("[i18n]: Fetching translations...");let g=await j(x);this.isLoading.set(!1);let f=Object.keys(g).reduce((u,p)=>d(l({},u),{[p]:Object.keys(g[p])}),{}),R=x.filter(({key:u,locale:p})=>(f[p]||[]).some(y=>`${y}`.startsWith(u))).reduce((u,{key:p,locale:y})=>d(l({},u),{[y]:[...u[y]||[],p]}),{});return[g,R]}return[]};this.addTranslations=(e,t)=>{var r;if(!e)return;(r=o(this.config))!=null&&r.debug&&console.debug("[i18n]: Adding translations...");let s=Object.keys(e||{});this.privateTranslations.update(a=>s.reduce((n,c)=>d(l({},n),{[c]:l(l({},n[c]||{}),P(e[c]))}),a)),s.forEach(a=>{let n=Object.keys(e[a]).map(c=>`${c}`.split(".")[0]);t&&(n=t[a]),this.loadedKeys[a]=Array.from(new Set([...this.loadedKeys[a]||[],...n||[]]))})};this.loader=async([e,t])=>{var r;(r=o(this.config))!=null&&r.debug&&console.debug("[i18n]: Adding loader promise.");let s=(async()=>{let a=await this.getTranslationProps(e,t);a.length&&this.addTranslations(...a)})();this.promises.add({locale:e,route:t,promise:s}),s.then(()=>{let a=this.getLocale(e);a&&this.locale.get()!==a&&this.locale.forceSet(a)})};this.loadTranslations=(e,t=o(this.currentRoute)||"")=>{if(!!e)return this.setRoute(t),this.setLocale(e),this.loading.toPromise(e,t)};e&&this.loadConfig(e),this.loaderTrigger.subscribe(this.loader),this.isLoading.subscribe(async t=>{var s;t&&this.promises.size&&(await this.loading.toPromise(),this.promises.clear(),(s=o(this.config))!=null&&s.debug&&console.debug("[i18n]: Loader promises have been purged."))})}async configLoader(e){if(!e)throw new Error("[i18n]: No config provided!");let c=e,{initLocale:t,fallbackLocale:s,translations:r,debug:a}=c,n=L(c,["initLocale","fallbackLocale","translations","debug"]);t=h(t)[0],s=h(s)[0],a&&console.debug("[i18n]: Setting config."),this.config.set(l({initLocale:t,fallbackLocale:s,translations:r,debug:a},n)),r&&this.addTranslations(r),await this.loadTranslations(t)}};export{O as default};
